<!DOCTYPE HTML>
<html>
	<head>
		<title>Goya Campaign Data Prototype</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="assets/css/main.css" />
		<noscript><link rel="stylesheet" href="assets/css/noscript.css" /></noscript>
		<link rel="shortcut icon" type="image/x-icon" href="images/favicon.ico">
	</head>
	<body class="is-preload">

		<!-- Wrapper -->
			<div id="wrapper">

				<!-- Header -->
					<header id="header" class="alt">
						<!--span class="logo"><img src="images/goyaLogoTiny.png" alt="" /></span-->
						<h1>Goya Campaign Data Prototype</h1>
						<p>Track your campaigns and explore insights like never before<br /> 
					</header>

				<!-- Nav -->
					<!--nav id="nav">
						<ul>
							<li><a href="#intro" class="active">Info</a></li>
							<li><a href="#first">Connect</a></li>
							<li><a href="#second">Insights</a></li> 
						</ul>
					</nav-->

				<!-- Main -->
					<div id="main">

						<!-- Introduction -->
							<section id="intro" class="main">
								<div class="spotlight">
									<div class="content">
										<header class="major">
											<h2>Info</h2>
										</header>
										<p>This prototype allows you to track social media metrics over time.</p>
										<p>We will save your data to a database and allow you to access insights. <br> To keep track of your data we will need an <b>access key</b> for each social media.</p>
										
										<p> To use this service you will need to give us your username.
											<div style = "display:flex;">
												<h4 id="uname_label" style ="display:none;"></h4>
												<input type="text" id="uname" name="uname" style="width: 40%;" onKeyUp="onUsernameInput()"> 
												<a id="uname_applyButton" style ="display:none;" onclick="GetTokenDataFromDB()" class="button primary">Apply</a> <br>
											</div> 
										</p>
										 
										<!--ul class="actions">
											<li><a href="generic.html" class="button">Learn More</a></li>
										</ul-->
									</div>
									<span class="image"><img src="images/pic01.jpg" alt="" /></span>
								</div>
							</section>

						<!-- First Section -->
							<section id="first" class="main special">
								<header class="major">
									<h2>Connect</h2>
									<h3 id = "warning_ConnectTab">PLEASE COMPLETE INFO SECTION TO SEE THIS</h3>
								</header>
								<div id = "content_ConnectTab"> 
								<ul class="features"> 
									<li style="overflow: hidden;text-overflow: '...';">
										<span class="image"><img src="images/instagramLogo.png" alt="" /></span> 
										
										<h3>Instagram - Basic API</h3> 
										<div style="line-height:30px;">
											Current key:
											<h6 id = "instagram_basicAPIAccessKey" style = "white-space: nowrap;overflow: clip;text-overflow: '...';font-size: 12px;">[None]</h6>
											<br>
										</div>
										<div id="instagram_basicAPISetDiv">
											Set via Instagram: <br>
											<a href="https://api.instagram.com/oauth/authorize?client_id=5589449261106354&redirect_uri=https://notelos.co/goyaSocialMediaTool&scope=user_profile,user_media&response_type=code" class="button primary">Set Key</a> <br>
											<br> 
										</div>
										<!--button type="submit" onclick="SendTokenToDB()">Send Token to Database</button-->
									</li>
									<li style="overflow: hidden;text-overflow: '...';">
										<span class="image"><img src="images/instagramLogo.png" alt="" /></span> 
										<h3>Instagram - Graph API</h3>  
										<div style="line-height:30px;">
											Current key:
											<h6 id = "instagram_graphAPIAccessKey" style = "white-space: nowrap;overflow: clip;text-overflow: '...';font-size: 12px;">[None]</h6>
											<br>
										</div>
										<div id="instagram_graphAPISetDiv"> 
											Set manually: <br> 
											<div style = "display:flex; height:15%;">
												<input type="text" id="instagramGraphAPIAccessKeyInput" name="graphAPIAccessKeyInputName">  
												<a onclick="SendInstaGraphAPIKeyToDB()" class="button primary">Apply</a>  
											</div>
										</div>

										<!--h6>Access Key <b>NOT</b> sent to database yet! </h6--> 
										<!--button type="submit" onclick="SendTokenToDB()">Send Token to Database</button-->
									</li>
									<li>
										<span class="image"><img src="images/giphyLogo.png" alt="" /></span> 
										<h3>Giphy</h3>
										<p>Work In Progress</p>
									</li>
								</ul> 
							</div> 

							</section>

						<!-- Second Section -->
							<section id="second" class="main special">
								<header class="major">
									<h2>Insights</h2>
									<h3 id = "warning_InsightsTab">PLEASE COMPLETE INFO SECTION TO SEE THIS</h3>
								</header>
								<div id = "content_InsightsTab">
									<p>Work In Progress</p>
								<!--ul class="statistics">
									<li class="style1">
										<span class="icon solid fa-code-branch"></span>
										<strong>0</strong> Connections
									</li>
									<li class="style2">
										<span class="icon fa-folder-open"></span>
										<strong>0</strong> Folders
									</li>
									<li class="style3">
										<span class="icon solid fa-signal"></span>
										<strong>0</strong> Scales
									</li>
									<li class="style4">
										<span class="icon solid fa-laptop"></span>
										<strong>0</strong> Integrations
									</li>
									<li class="style5">
										<span class="icon fa-heart"></span>
										<strong>0</strong> Likes
									</li>
								</ul-->
								</div>
							</section>
							<br>
							<p></p>

						<!-- Get Started -->
							<!--section id="cta" class="main special">
								<header class="major">
									<h2>Congue imperdiet</h2>
									<p>Donec imperdiet consequat consequat. Suspendisse feugiat congue<br />
									posuere. Nulla massa urna, fermentum eget quam aliquet.</p>
								</header>
								<footer class="major">
									<ul class="actions special">
										<li><a href="generic.html" class="button primary">Get Started</a></li>
										<li><a href="generic.html" class="button">Learn More</a></li>
									</ul>
								</footer>
							</section-->

					</div>

				<!-- Footer -->
					<!--footer id="footer">
						<section>
							<h2>Aliquam sed mauris</h2>
							<p>Sed lorem ipsum dolor sit amet et nullam consequat feugiat consequat magna adipiscing tempus etiam dolore veroeros. eget dapibus mauris. Cras aliquet, nisl ut viverra sollicitudin, ligula erat egestas velit, vitae tincidunt odio.</p>
							<ul class="actions">
								<li><a href="generic.html" class="button">Learn More</a></li>
							</ul>
						</section>
						<section>
							<h2>Etiam feugiat</h2>
							<dl class="alt">
								<dt>Address</dt>
								<dd>1234 Somewhere Road &bull; Nashville, TN 00000 &bull; USA</dd>
								<dt>Phone</dt>
								<dd>(000) 000-0000 x 0000</dd>
								<dt>Email</dt>
								<dd><a href="#">information@untitled.tld</a></dd>
							</dl>
							<ul class="icons">
								<li><a href="#" class="icon brands fa-twitter alt"><span class="label">Twitter</span></a></li>
								<li><a href="#" class="icon brands fa-facebook-f alt"><span class="label">Facebook</span></a></li>
								<li><a href="#" class="icon brands fa-instagram alt"><span class="label">Instagram</span></a></li>
								<li><a href="#" class="icon brands fa-github alt"><span class="label">GitHub</span></a></li>
								<li><a href="#" class="icon brands fa-dribbble alt"><span class="label">Dribbble</span></a></li>
							</ul>
						</section> 
					</footer-->

			</div>

		<!-- Scripts -->
			<script>
				//Cookies related only:
				
				//try to access existing cookie after the page loads:
				let devMode = false;
				let databaseURL = "https://goya1-bc87.restdb.io/";
				let databaseK = "62eec7c6efe26c66934b7924";
				let savedUsername;
				let savedAccessKey;

				window.addEventListener('load',() => {
					savedUsername = getCookie("username");  

					if(savedUsername === undefined)
					{
						document.getElementById("uname").value = ""; 
						savedUsername = "";
					}
					
					if(savedUsername !== "") {
						console.log("Username cookie loaded: " + savedUsername);
						document.getElementById("uname").value = savedUsername;  
					} 
					toggleUnameApplyButton();
					toggleUsernameDependantFeatures(false);

					tryGetInstagramAccessKey();

					if(devMode)
					{
						savedUsername = "devMode";
						GetTokenDataFromDB();
					}
				});
				
				function getCookie(c_name) {
					var i,x,y,ARRcookies=document.cookie.split(";");

					for (i=0;i<ARRcookies.length;i++)
					{
						x=ARRcookies[i].substr(0,ARRcookies[i].indexOf("="));
						y=ARRcookies[i].substr(ARRcookies[i].indexOf("=")+1);
						x=x.replace(/^\s+|\s+$/g,"");
						if (x==c_name)
						{
							return unescape(y);
						}
					}
				}
				
				//save cookie when user inputs username
				function onUsernameInput()
				{
					let unameVal = document.getElementById("uname").value;
					console.log(">>>>>>>>>Username " + unameVal+ " Saved in Cookies!");
					document.cookie = "username=" + unameVal + ";expires=Fri, 31 Dec 9999 23:59:59 GMT;path=/;SameSite=Lax"; 
					savedUsername = unameVal;
					toggleUnameApplyButton(); 
				}


			</script>
			<script>
				//useful references
			 
				//
  
				function GetTokenDataFromDB()
				{ 
					//get token data from user
					GetTokensFromDB();
					//if the username is not null or undefined...
					toggleUsernameDependantFeatures(true);
					document.getElementById('uname_applyButton').style.display = 'none'; 
					document.getElementById('uname').style.display= 'none';
					document.getElementById('uname_label').innerHTML = "Your username is: <b>" + savedUsername + "</b>";
					document.getElementById('uname_label').style.display= 'block';
				}

				//unlocks some sections if username has been inputted: 
				function toggleUnameApplyButton()
				{ 
					document.getElementById('uname_applyButton').style.display=(savedUsername !== "")?'block':'none';
					
					
				}

				function toggleUsernameDependantFeatures (_newState) {
				
					document.getElementById('warning_ConnectTab').style.display=_newState?'none':'block';
					document.getElementById('warning_InsightsTab').style.display=_newState?'none':'block';
					document.getElementById('content_ConnectTab').style.display=_newState?'block':'none';
					document.getElementById('content_InsightsTab').style.display=_newState?'block':'none'; 
					document.getElementById('second').style.display=_newState?'block':'none'; 
					document.getElementById('first').style.display=_newState?'block':'none'; 
				}


				//instagram access key related:

				function tryGetInstagramAccessKey()
				{
					let accessKey = getInstagramAccessKeyFromURL(window.location.href);
					
					if(accessKey != "")
					{
						document.getElementById('instagram_basicAPIAccessKey').textContent = accessKey; 
						document.getElementById('instagram_basicAPISetDiv').style.display= 'none';
						savedAccessKey = accessKey; 
						SendInstaBasicAccessKeyToDB();
						window.location.href = 'https://notelos.co/goyaSocialMediaTool/'; 
					} 
					
					//console.log(document.getElementById('instagram_accessKey').textContent);
				}

				function getInstagramAccessKeyFromURL(url) {
					var urlSections=url.split("?code="); 
					return urlSections.length > 1 ? urlSections[1].slice(0, -2) : ""; 
				} 
				
				function GetTokensFromDB()
				{
					let xhttp = new XMLHttpRequest();
					xhttp.open("GET", databaseURL + "rest/tokens", false); 
					xhttp.setRequestHeader("Accept", "application/json");
					xhttp.setRequestHeader("Content-type", "application/json");
					xhttp.setRequestHeader("x-apikey", databaseK);
					xhttp.send(null);
					//console.log(xhttp.responseText);
					const json = xhttp.responseText;
					const obj = JSON.parse(json);
					for(let i = 0; i < obj.length; i++)
					{
						if(obj[i].username === savedUsername) 
						{ 
							console.log(obj[i].username);
							if(obj[i].type == "instagram_basicAPI")
							{
								console.log(obj[i]);
								document.getElementById('instagram_basicAPIAccessKey').textContent = obj[i].access_key; 
								document.getElementById('instagram_basicAPISetDiv').style.display= 'none';
								// 
							} 
							if(obj[i].type == "instagram_graphAPI")
							{
								document.getElementById('instagram_graphAPIAccessKey').textContent = obj[i].access_key; 
								document.getElementById('instagram_graphAPISetDiv').style.display= 'none';
							}
						} 
					}
					
					//return xmlHttpReq.responseText;
				}

				//send token to db via link
				function SendInstaBasicAccessKeyToDB() {
					console.log("Sending token to DB!"); 
					var xhttp = new XMLHttpRequest();
					xhttp.onreadystatechange = function() {
						if (this.readyState == 4 && this.status == 200) {
							alert(this.responseText);
						}
					};
					xhttp.open("POST", databaseURL + "rest/tokens", true);
					xhttp.setRequestHeader("Content-type", "application/json");
					xhttp.setRequestHeader("x-apikey", databaseK); 
					xhttp.send('{"access_key":"' + savedAccessKey + '","username":"' + savedUsername + '","type":"instagram_basicAPI"}');
				}

				function SendInstaGraphAPIKeyToDB()
				{  
					let keyToSend = document.getElementById('instagramGraphAPIAccessKeyInput').value;

					var xhttp = new XMLHttpRequest();
					xhttp.onreadystatechange = function() {
						if (this.readyState == 4 && this.status == 200) {
							alert(this.responseText);
						}
					};
					xhttp.open("POST", databaseURL + "rest/tokens", true);
					xhttp.setRequestHeader("Content-type", "application/json");
					xhttp.setRequestHeader("x-apikey", databaseK); 
					xhttp.send('{"access_key":"' + keyToSend + '","username":"' + savedUsername + '","type":"instagram_graphAPI"}');  
					document.getElementById('instagram_graphAPIAccessKey').textContent = keyToSend; 
					document.getElementById('instagram_graphAPISetDiv').style.display= 'none';  
				}
														
			</script> 
			
			<script src="assets/js/jquery.min.js"></script>
			<script src="assets/js/jquery.scrollex.min.js"></script>
			<script src="assets/js/jquery.scrolly.min.js"></script>
			<script src="assets/js/browser.min.js"></script>
			<script src="assets/js/breakpoints.min.js"></script>
			<script src="assets/js/util.js"></script>
			<script src="assets/js/main.js"></script>

	</body>
</html>